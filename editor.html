<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LudvigEditor 7.0</title>

<style>
html,body {
    margin:0;
    width:100%;
    height:100%;
    background:#0e0f1f;
    overflow:hidden;
    font-family:Segoe UI, sans-serif;
}
#editor {
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:220px;
}
#terminals {
    position:absolute;
    bottom:0;
    height:220px;
    left:0;
    right:0;
    display:flex;
    background:linear-gradient(135deg,#1a1c3a,#3f2b96);
}
.term {
    flex:1;
    margin:4px;
    padding:8px;
    border-radius:8px;
    background:#0f1224;
    font-family:Consolas, monospace;
    overflow:auto;
    white-space:pre-wrap;
}
.stdout { color:#4EC9B0 }
.stderr { color:#F44747 }
.info { color:#569CD6 }
</style>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pyodide@0.24.1/full/pyodide.js"></script>

<script>
require.config({ paths:{vs:'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs'} });

let editor, pyodideReady=false;

const DOCS = {
  "QApplication":"Main application object (PyQt6.QtWidgets)",
  "QMainWindow":"Main application window class",
  "QWidget":"Base class for all UI objects",
  "QTimer":"Timer for repeated or single-shot events",
  "QThread":"Thread class for background tasks",
  "pyqtSignal":"Signal for Qt event system",
  "Path":"High-level filesystem paths",
  "subprocess":"Spawn processes and connect pipes",
  "requests":"HTTP library",
  "json":"JSON encoder/decoder",
  "threading":"High-level threading API"
};

async function initPyodide(){
    window.pyodide = await loadPyodide();
    await pyodide.loadPackage(["pyflakes","pycodestyle"]);
    pyodideReady = true;
}
initPyodide();

require(["vs/editor/editor.main"],()=>{
    monaco.editor.defineTheme("ludvig-dark",{
        base:"vs-dark",
        inherit:true,
        rules:[
            {token:"keyword",foreground:"C586C0"},
            {token:"string",foreground:"CE9178"},
            {token:"number",foreground:"B5CEA8"},
            {token:"comment",foreground:"6A9955",fontStyle:"italic"},
            {token:"type.identifier",foreground:"4EC9B0"},
            {token:"identifier",foreground:"D4D4D4"}
        ],
        colors:{
            "editor.background":"#0f1224",
            "editor.lineHighlightBackground":"#1a1b3a"
        }
    });

    editor = monaco.editor.create(document.getElementById("editor"),{
        value:"",
        language:"python",
        theme:"ludvig-dark",
        fontSize:14,
        minimap:{enabled:false},
        smoothScrolling:true,
        cursorSmoothCaretAnimation:"on",
        automaticLayout:true
    });

    // AUTOCOMPLETE
    monaco.languages.registerCompletionItemProvider("python",{
        provideCompletionItems(){
            const words = Object.keys(DOCS);
            return {
                suggestions: words.map(w=>({
                    label:w,
                    kind:monaco.languages.CompletionItemKind.Class,
                    insertText:w
                }))
            };
        }
    });

    // HOVER DOCS
    monaco.languages.registerHoverProvider("python",{
        provideHover(model,pos){
            const word = model.getWordAtPosition(pos);
            if(word && DOCS[word.word]){
                return {
                    contents:[{value:"**"+word.word+"**\n\n"+DOCS[word.word]}]
                };
            }
        }
    });

    // LINT
    async function lint(){
        if(!pyodideReady) return;
        const code = editor.getValue();
        const result = await pyodide.runPythonAsync(`
import pyflakes.api, pyflakes.reporter, io
out=io.StringIO()
rep=pyflakes.reporter.Reporter(out,out)
pyflakes.api.check(${JSON.stringify(code)},"<editor>",rep)
out.getvalue()
        `);
        const markers=[];
        result.split("\\n").forEach(l=>{
            const m=l.match(/<editor>:(\\d+):(.+)/);
            if(m){
                markers.push({
                    startLineNumber:+m[1],
                    endLineNumber:+m[1],
                    startColumn:1,
                    endColumn:1,
                    message:m[2],
                    severity:monaco.MarkerSeverity.Error
                });
            }
        });
        monaco.editor.setModelMarkers(editor.getModel(),"lint",markers);
    }

    editor.onDidChangeModelContent(()=>lint());
});

// PYQT BRIDGE
window.loadFromPy=(code)=>editor.setValue(code);
window.getCode=()=>editor.getValue();
window.term=(t,c)=> {
    let d=document.createElement("div");
    d.className="term "+c;
    d.textContent=t;
    document.getElementById("terminals").appendChild(d);
};
window.clearTerm=()=>document.getElementById("terminals").innerHTML="";
</script>
</head>
<body>
<div id="editor"></div>
<div id="terminals"></div>
</body>
</html>
