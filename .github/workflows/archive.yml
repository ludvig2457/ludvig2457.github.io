name: Archive All Site Versions

# Запускаем вручную или при пуше в main
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      # Клонируем репозиторий с полной историей
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Важно: чтобы получить всю историю коммитов

      # Архивируем каждый коммит на Internet Archive
      - name: Archive all commits
        run: |
          echo "Starting to archive all commits..."
          git log --pretty=format:%H | while read commit_hash; do
            git checkout $commit_hash
            echo "Archiving commit $commit_hash..."
            # Отправляем сайт в Wayback Machine и сохраняем HTTP-код
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://web.archive.org/save/https://ludvig2457.github.io/" || true)
            echo "Commit $commit_hash archived. HTTP status: $STATUS"
            # Делаем небольшую паузу, чтобы не перегружать сервер
            sleep 5
          done
          echo "All commits processed!"
