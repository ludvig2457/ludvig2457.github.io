name: Archive All Site Versions

# Запускаем вручную или при пуше в main
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      # Клонируем репозиторий с полной историей
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Важно: чтобы получить всю историю коммитов

      # Архивируем каждый коммит на Internet Archive
      - name: Archive all commits
        run: |
          echo "Starting to archive all commits..."
          git log --pretty=format:%H | while read commit_hash; do
            git checkout $commit_hash
            echo "Processing commit $commit_hash..."
            
            # Отправляем сайт в Wayback Machine
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://web.archive.org/save/https://ludvig2457.github.io/" || true)

            if [ "$STATUS" -eq 200 ]; then
              echo "✅ Commit $commit_hash successfully archived."
            else
              echo "⚠️ Commit $commit_hash not archived. HTTP status: $STATUS"
            fi

            # Делаем паузу 60 секунд между запросами
            sleep 60
          done
          echo "All commits processed!"
